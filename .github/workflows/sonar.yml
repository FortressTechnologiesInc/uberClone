name: SonarQube Scan

on:
  push:
    branches:
      - master

jobs:
  sonarqube_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker
      run: |
        docker pull sonarqube:lts-community
        docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqube:lts-community
        sleep 1
      # You might need to adjust the sleep duration based on your SonarQube startup time

    - name: Install unzip
      run: |
        docker exec -u root  sonarqube /bin/sh -c "apt-get update && apt-get install -y unzip"
      # Install unzip with elevated privileges

    - name: Download and configure SonarScanner
      run: |
        docker exec -u root sonarqube /bin/sh -c "wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip -P /opt/"
        docker exec -u root sonarqube /bin/sh -c "unzip /opt/sonar-scanner-cli-4.6.2.2472-linux.zip -d /opt/"
        docker exec -u root sonarqube /bin/sh -c "export PATH=\$PATH:/opt/sonar-scanner-4.6.2.2472-linux/bin/"
      # Adjust the version and URL as needed

    - name: Run SonarQube analysis
      run: |
        docker exec -u 0 sonarqube /bin/sh -c "/opt/sonar-scanner-4.6.2.2472-linux/bin/sonar-scanner -Dsonar.host.url=https://192.168.3.17:3128 -Dsonar.login=squ_fcd51069e8f0f1e4838f37df32fd564c2cd4a860"
      # Replace <SONAR_LOGIN_TOKEN> with your SonarQube login token

    - name: Stop and remove SonarQube container
      run: docker stop sonarqube
